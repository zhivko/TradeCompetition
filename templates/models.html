{% extends "base.html" %}

{% block title %}MODELS - Trading Dashboard{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-clock"></i> Last Update: <span id="last-update-timestamp">Loading...</span>
            </div>
            <div id="connection-status">
                <i class="fas fa-circle text-warning"></i> Connecting...
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-robot"></i> Agent Models Overview
                </h4>
            </div>
            <div class="card-body">
                <div id="models-overview">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Agent Details Cards -->
    <div class="col-12" id="agent-details-container">
        <!-- Agent cards will be populated here -->
    </div>
</div>

<!-- Agent Details Modal -->
<div class="modal fade" id="agentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agentModalTitle">Agent Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="agent-details-content">
                    <!-- Agent details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    let currentAgents = null;

    socket.on('connect', function() {
        console.log('Connected to server');
        updateConnectionStatus(true);
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
        updateConnectionStatus(false);
    });

    socket.on('data_update', function(data) {
        currentAgents = data.agents;
        updateModelsOverview(data.agents);
        updateAgentDetails(data.agents);
        updateTimestamp(data.timestamp);
    });

    socket.on('status', function(data) {
        console.log('Status:', data.message);
    });

    // Request initial data
    socket.emit('request_update');

    // Update every 5 seconds
    setInterval(() => {
        if (socket.connected) {
            socket.emit('request_update');
        }
    }, 5000);

    function updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connection-status');
        if (connected) {
            statusEl.innerHTML = '<i class="fas fa-circle text-success"></i> Connected';
        } else {
            statusEl.innerHTML = '<i class="fas fa-circle text-danger"></i> Disconnected';
        }
    }

    function updateTimestamp(timestamp) {
        const timestampEl = document.getElementById('last-update-timestamp');
        if (timestamp) {
            const date = new Date(timestamp);
            timestampEl.textContent = date.toLocaleString();
        } else {
            timestampEl.textContent = 'Unknown';
        }
    }

    function updateModelsOverview(agents) {
        const container = document.getElementById('models-overview');

        if (!agents || agents.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No agent data available</div>';
            return;
        }

        // Calculate summary statistics
        const totalAgents = agents.length;
        const activeAgents = agents.filter(agent => agent.active_trades_count > 0).length;
        const totalActiveTrades = agents.reduce((sum, agent) => sum + agent.active_trades_count, 0);
        const totalClosedTrades = agents.reduce((sum, agent) => sum + agent.closed_trades_count, 0);
        const avgSharpe = agents.reduce((sum, agent) => sum + (agent.summary.sharpe_ratio || 0), 0) / totalAgents;

        let html = `
            <div class="row text-center">
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="h2 mb-0 text-primary">${totalAgents}</div>
                            <small class="text-muted">Total Models</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="h2 mb-0 text-success">${activeAgents}</div>
                            <small class="text-muted">Active Models</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="h2 mb-0 text-info">${totalActiveTrades}</div>
                            <small class="text-muted">Active Positions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="h2 mb-0 text-secondary">${totalClosedTrades}</div>
                            <small class="text-muted">Completed Trades</small>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h6>Model Types Distribution</h6>
                    <div id="model-types-chart"></div>
                </div>
                <div class="col-md-6">
                    <h6>Performance Metrics</h6>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Average Sharpe Ratio:</span>
                            <strong>${avgSharpe.toFixed(4)}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Models with Active Trades:</span>
                            <strong>${activeAgents}/${totalAgents}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Trading Activity:</span>
                            <strong>${totalActiveTrades + totalClosedTrades} trades</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // Create model types chart
        updateModelTypesChart(agents);
    }

    function updateModelTypesChart(agents) {
        // Group agents by type
        const typeCounts = {};
        agents.forEach(agent => {
            const type = agent.kind.split('Agent')[1] || agent.kind; // Extract type after "Agent"
            typeCounts[type] = (typeCounts[type] || 0) + 1;
        });

        const types = Object.keys(typeCounts);
        const counts = Object.values(typeCounts);

        const data = [{
            type: 'pie',
            labels: types,
            values: counts,
            marker: {
                colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
            }
        }];

        const layout = {
            margin: { t: 0, b: 0, l: 0, r: 0 },
            height: 200,
            showlegend: true,
            legend: { orientation: 'h', y: -0.2 }
        };

        Plotly.newPlot('model-types-chart', data, layout);
    }

    function updateAgentDetails(agents) {
        const container = document.getElementById('agent-details-container');

        if (!agents || agents.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No agent data available</div>';
            return;
        }

        let html = '<div class="row">';

        agents.forEach(agent => {
            const pnlClass = agent.pnl >= 0 ? 'text-success' : 'text-danger';
            const pnlIcon = agent.pnl >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
            const statusClass = agent.active_trades_count > 0 ? 'bg-success' : 'bg-warning';
            const statusText = agent.active_trades_count > 0 ? 'Active' : 'Idle';

            html += `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-robot"></i> ${agent.kind}
                            </h6>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="h5 mb-0 ${pnlClass}">
                                        <i class="${pnlIcon}"></i>
                                        $${agent.pnl.toFixed(2)}
                                    </div>
                                    <small class="text-muted">PNL</small>
                                </div>
                                <div class="col-6">
                                    <div class="h5 mb-0">${agent.pnl_percentage.toFixed(2)}%</div>
                                    <small class="text-muted">Return</small>
                                </div>
                            </div>

                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <div class="h6 mb-0">$${agent.summary.available_cash?.toFixed(2) || '0.00'}</div>
                                    <small class="text-muted">Cash</small>
                                </div>
                                <div class="col-4">
                                    <div class="h6 mb-0">${agent.summary.sharpe_ratio?.toFixed(4) || '0.0000'}</div>
                                    <small class="text-muted">Sharpe</small>
                                </div>
                                <div class="col-4">
                                    <div class="h6 mb-0">${agent.active_trades_count + agent.closed_trades_count}</div>
                                    <small class="text-muted">Total Trades</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: ${(agent.active_trades_count / Math.max(agent.active_trades_count + agent.closed_trades_count, 1)) * 100}%"></div>
                                    <div class="progress-bar bg-secondary" style="width: ${(agent.closed_trades_count / Math.max(agent.active_trades_count + agent.closed_trades_count, 1)) * 100}%"></div>
                                </div>
                                <small class="text-muted">
                                    Active: ${agent.active_trades_count} | Closed: ${agent.closed_trades_count}
                                </small>
                            </div>

                            <button class="btn btn-outline-primary btn-sm w-100" onclick="showAgentDetails('${agent.kind}')">
                                <i class="fas fa-info-circle"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // Global function for showing agent details
    window.showAgentDetails = function(agentKind) {
        const agent = currentAgents.find(a => a.kind === agentKind);
        if (!agent) return;

        const modal = new bootstrap.Modal(document.getElementById('agentModal'));
        document.getElementById('agentModalTitle').textContent = `${agent.kind} - Details`;

        let detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Performance Summary</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Current Value:</strong></td>
                            <td>$${agent.summary.current_account_value?.toFixed(2) || '0.00'}</td>
                        </tr>
                        <tr>
                            <td><strong>Available Cash:</strong></td>
                            <td>$${agent.summary.available_cash?.toFixed(2) || '0.00'}</td>
                        </tr>
                        <tr>
                            <td><strong>PNL:</strong></td>
                            <td class="${agent.pnl >= 0 ? 'text-success' : 'text-danger'}">
                                $${agent.pnl.toFixed(2)} (${agent.pnl_percentage.toFixed(2)}%)
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Sharpe Ratio:</strong></td>
                            <td>${agent.summary.sharpe_ratio?.toFixed(4) || '0.0000'}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Trading Activity</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Active Trades:</strong></td>
                            <td>${agent.active_trades_count}</td>
                        </tr>
                        <tr>
                            <td><strong>Closed Trades:</strong></td>
                            <td>${agent.closed_trades_count}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Trades:</strong></td>
                            <td>${agent.active_trades_count + agent.closed_trades_count}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6>Latest Response</h6>
        `;

        if (agent.latest_response) {
            const response = agent.latest_response;
            const responseTimestamp = agent.timestamp ? new Date(agent.timestamp).toLocaleString() : 'Unknown';
            detailsHtml += `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">Trading Decision</h6>
                            <small class="text-muted"><i class="fas fa-clock"></i> ${responseTimestamp}</small>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Action:</strong> ${response.action || 'N/A'}</p>
                                <p><strong>Symbol:</strong> ${response.symbol || 'N/A'}</p>
                                <p><strong>Confidence:</strong> ${(response.confidence * 100 || 0).toFixed(1)}%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Reason:</strong></p>
                                <p class="text-muted">${response.reason || 'No reason provided'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            detailsHtml += '<p class="text-muted">No recent trading decisions available.</p>';
        }

        detailsHtml += `
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6>Active Trades</h6>
        `;

        if (agent.active_trades && agent.active_trades.length > 0) {
            detailsHtml += '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Symbol</th><th>Entry Price</th><th>Quantity</th><th>Stop Loss</th><th>Unrealized PNL</th><th>Timestamp</th></tr></thead><tbody>';

            agent.active_trades.forEach(trade => {
                const unrealizedPnl = trade.unrealized_pnl || 0;
                const pnlClass = unrealizedPnl >= 0 ? 'text-success' : 'text-danger';
                detailsHtml += `
                    <tr>
                        <td>${trade.symbol || 'N/A'}</td>
                        <td>$${trade.entry_price?.toFixed(2) || '0.00'}</td>
                        <td>${trade.quantity || '0'}</td>
                        <td>$${trade.stop_loss?.toFixed(2) || '0.00'}</td>
                        <td class="${pnlClass}">$${unrealizedPnl.toFixed(2)}</td>
                        <td>${trade.timestamp || 'N/A'}</td>
                    </tr>
                `;
            });

            detailsHtml += '</tbody></table></div>';
        } else {
            detailsHtml += '<p class="text-muted">No active trades.</p>';
        }

        detailsHtml += `
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6>Closed Trades</h6>
        `;

        if (agent.closed_trades && agent.closed_trades.length > 0) {
            detailsHtml += '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Symbol</th><th>Entry Price</th><th>Exit Price</th><th>Quantity</th><th>PNL</th><th>Timestamp</th></tr></thead><tbody>';

            agent.closed_trades.forEach(trade => {
                const pnlClass = (trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger';
                detailsHtml += `
                    <tr>
                        <td>${trade.symbol || 'N/A'}</td>
                        <td>$${trade.entry_price?.toFixed(2) || '0.00'}</td>
                        <td>$${trade.exit_price?.toFixed(2) || '0.00'}</td>
                        <td>${trade.quantity || '0'}</td>
                        <td class="${pnlClass}">$${trade.pnl?.toFixed(2) || '0.00'}</td>
                        <td>${trade.timestamp || 'N/A'}</td>
                    </tr>
                `;
            });

            detailsHtml += '</tbody></table></div>';
        } else {
            detailsHtml += '<p class="text-muted">No closed trades.</p>';
        }

        detailsHtml += `
                </div>
            </div>
        `;

        document.getElementById('agent-details-content').innerHTML = detailsHtml;
        modal.show();
    };
});
</script>
{% endblock %}